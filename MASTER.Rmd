---
title: "Novel oral anticoagulants network meta-analysis"
author: "Benjamin Chan"
date: "`r Sys.time()`"
output: 
  html_document: 
    keep_md: yes
    toc: yes
---


This network meta-analysis is an update to
[Fu *et al*, 2014](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC4244213/),
*J Cardiovasc Med (Hagerstown).* 2014 Dec; 15(12): 873-879.

> From: Marian McDonagh  
> Sent: Friday, January 29, 2016 4:19 PM  
> To: Benjamin Chan  
> Subject: Re: Network Meta-analysis  
> 
> OK, last email for today!
> I put it all into an excel spreadsheet --- all the outcomes.
> Looks like it might not add up to much since several outcome cells are 0's.
> Let me know what you think.

Use the [`gemtc`](https://drugis.org/software/r-packages/gemtc) package.
Check the link for references.

```{r}
library(openxlsx)
library(data.table)
library(gemtc)
```

```{r, echo=FALSE}
file.info("NOAC NMA Data.xlsx")[, c("mtime", "size")]

readSheet <- function (sheet) {
  D <- data.table(read.xlsx("NOAC NMA Data.xlsx", sheet=sheet, startRow=3, cols=1:5))
  names(D) <- c("label", "nNOAC", "yNOAC", "nWarfarin", "yWarfarin")
  D
}

tidyData <- function (D) {
  names(D) <- c("label", "nNOAC", "yNOAC", "nWarfarin", "yWarfarin")
  D <- D[, label := gsub("\\s{2,}", " ", label)]
  D <- D[, label := gsub("\\s$", "", label)]
  D <- D[, label := gsub("\\sivaroxaban", " Rivaroxaban", label)]
  D <- D[, label := gsub("0$", "0 mg", label)]
  D <- D[, `:=` (study = NA_character_, noac = NA_character_)]
  assignStudy <- function (str) {
    D[grep(str, label), study := str]
  }
  assignNOAC <- function (str) {
    D[grep(str, label), noac := str]
  }
  D <- assignStudy("RE-LY")
  D <- assignStudy("ENGAGE AF-TIMI")
  D <- assignStudy("Yamashita, 2012")
  D <- assignStudy("ARISTOTLE")
  D <- assignStudy("ARISTOTLE-J")
  D <- assignStudy("J-ROCKET")
  D <- assignStudy("ROCKET-AF")
  D <- assignStudy("PETRO")
  D <- assignStudy("Mao, 2014")
  D <- assignNOAC("Dabigatran 110 mg")
  D <- assignNOAC("Dabigatran 150 mg")
  D <- assignNOAC("Edoxaban 30 mg")
  D <- assignNOAC("Edoxaban 60 mg")
  D <- assignNOAC("Apixaban 5 mg")
  D <- assignNOAC("Rivaroxaban 15 mg")
  D <- assignNOAC("Rivaroxaban 20 mg")
  D <- D[, label := NULL]
  D <- melt(D, id.vars=c("study", "noac"))
  D <- rbindlist(list(merge(D[variable == "nNOAC"],
                            D[variable == "yNOAC"],
                            by=c("study", "noac")),
                      merge(D[variable == "nWarfarin"],
                            D[variable == "yWarfarin"],
                            by=c("study", "noac"))))
  D <- D[grep("NOAC", variable.x), treatment := noac]
  D <- D[grep("Warfarin", variable.x), treatment := "Warfarin"]
  D <- D[, treatment := gsub(" ", "_", treatment)]
  D <- D[, noac := NULL]
  D <- D[, `:=` (variable.x = NULL, variable.y = NULL)]
  setnames(D, c("value.x", "value.y"), c("sampleSize", "responders"))
  setkey(D, study, treatment)
  setcolorder(D, c("study", "treatment", "responders", "sampleSize"))
  D <- unique(D)
  # D <- D[study %in% c("RE-LY", "ARISTOTLE", "ROCKET-AF", "ENGAGE AF-TIMI")]  # Replicate Fu 2014
  D
}
```


# Mortality

Clean up the data (do not show the code).

```{r, echo=FALSE}
D1 <- readSheet("Mortality")
D1 <- tidyData(D1)
show(D1)
```

Plot the network.

```{r mortalityNetwork}
network <- mtc.network(D1)
plot(network)
```

Run the model.

```{r, results='hide'}
M <- mtc.model(network, type="consistency", linearModel="random")
runtime <- system.time(results <- mtc.run(M, n.adapt=5000, n.iter=20000, thin=10))
```

```{r}
runtime
```

Sampler diagnostics.

```{r mortalityGelman, fig.height=8}
gelman.plot(results)
gelman.diag(results)
```

```{r mortalityTrace, fig.height=10}
plot(results)
```

Summary.

```{r mortalityForest}
summary(results)
forest(results)
```

Assess the degree of heterogeneity and inconsistency.

```{r, results='hide'}
anohe <- mtc.anohe(network, n.adapt=5000, n.iter=20000, thin=10)
```

```{r mortalityAnohe, fig.height=8}
summary(anohe)
plot(anohe)
```


# Stroke

Clean up the data (do not show the code).

```{r, echo=FALSE}
D2 <- readSheet("Stroke")
D2 <- tidyData(D2)
show(D2)
```


Plot the network.

```{r strokeNetwork}
network <- mtc.network(D2)
plot(network)
```

Run the model.

```{r, results='hide'}
M <- mtc.model(network, type="consistency", linearModel="random")
runtime <- system.time(results <- mtc.run(M, n.adapt=5000, n.iter=20000, thin=10))
```

```{r}
runtime
```

Sampler diagnostics.

```{r strokeGelman, fig.height=8}
gelman.plot(results)
gelman.diag(results)
```

```{r strokeTrace, fig.height=10}
plot(results)
```

Summary.

```{r strokeForest}
summary(results)
forest(results)
```

Assess the degree of heterogeneity and inconsistency.

```{r, results='hide'}
anohe <- mtc.anohe(network, n.adapt=5000, n.iter=20000, thin=10)
```

```{r strokeAnohe, fig.height=8}
summary(anohe)
plot(anohe)
```


# MI

Clean up the data (do not show the code).

```{r, echo=FALSE}
D3 <- readSheet("MI")
D3 <- tidyData(D3)
show(D3)
```


Plot the network.

```{r miNetwork}
network <- mtc.network(D3)
plot(network)
```

Run the model.

```{r, results='hide'}
M <- mtc.model(network, type="consistency", linearModel="random")
runtime <- system.time(results <- mtc.run(M, n.adapt=5000, n.iter=20000, thin=10))
```

```{r}
runtime
```

Sampler diagnostics.

```{r miGelman, fig.height=8}
gelman.plot(results)
gelman.diag(results)
```

```{r miTrace, fig.height=10}
plot(results)
```

Summary.

```{r miForest}
summary(results)
forest(results)
```

Assess the degree of heterogeneity and inconsistency.

```{r, results='hide'}
anohe <- mtc.anohe(network, n.adapt=5000, n.iter=20000, thin=10)
```

```{r miAnohe, fig.height=8}
summary(anohe)
plot(anohe)
```


# Bleeding

Clean up the data (do not show the code).

```{r, echo=FALSE}
D4 <- readSheet("Bleeding")
D4 <- tidyData(D4)
show(D4)
```


Plot the network.

```{r bleedingNetwork}
network <- mtc.network(D4[!is.na(responders)])
plot(network)
```

Run the model.

```{r, results='hide'}
M <- mtc.model(network, type="consistency", linearModel="random")
runtime <- system.time(results <- mtc.run(M, n.adapt=5000, n.iter=20000, thin=10))
```

```{r}
runtime
```

Sampler diagnostics.

```{r bleedingGelman, fig.height=8}
gelman.plot(results)
gelman.diag(results)
```

```{r bleedingTrace, fig.height=10}
plot(results)
```

Summary.

```{r bleedingForest}
summary(results)
forest(results)
```

Assess the degree of heterogeneity and inconsistency.

```{r, results='hide'}
anohe <- mtc.anohe(network, n.adapt=5000, n.iter=20000, thin=10)
```

```{r bleedingAnohe, fig.height=8}
summary(anohe)
plot(anohe)
```
